- name: setup direcrories
  file:
    path: '{{ item }}'
    state: directory
    owner: "{{ ansible_user }}"
  loop:
    - "{{ ghq_root }}"
    - /opt/bin/go
- name: git clone dotfiles
  git:
    repo: https://github.com/cumet04/dotfiles.git
    dest: "{{ dotfiles_root }}"
    version: "{{ ansible_env.BRANCH | default('master') }}"
    depth: 1
    update: no
    accept_hostkey: yes

# remove ~/.config if exists as directory (not link)
# linking of next step is failed if it exists.
- name: clean ~/.config
  block:
    - stat:
        path: "{{ ansible_env.HOME }}/.config"
      register: config
    - file:
        path: "{{ ansible_env.HOME }}/.config"
        state: absent
      when: config.stat.isdir is defined and config.stat.isdir

- name: install dotfiles symlinks
  file:
    src: "{{ dotfiles_root }}/home/{{ item }}"
    dest: "{{ ansible_env.HOME }}/{{ item }}"
    state: link
  loop:
    - .config
    - .gitconfig

- name: symlink shell_commands
  file:
    src: "{{ dotfiles_root }}/shell_commands"
    dest: /opt/bin/shell_commands
    state: link
- name: symlink wsl.conf
  become: true
  file:
    src: "{{ dotfiles_root }}/configs/wsl.conf"
    dest: /etc/wsl.conf
    state: link
- name: ignore gitconfig change
  shell: |
    cd {{ dotfiles_root}}
    git update-index --skip-worktree home/.gitconfig
